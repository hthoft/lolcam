<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Camera Background App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css">
    <script src="{{ url_for('static', filename='qrcode.min.js') }}"></script>
    <style>
        /* Performance optimizations */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            overflow: hidden; /* Prevent scrolling */
            margin: 0;
            padding: 0;
        }

        .camera-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 1280px;
            height: 800px;
            background-color: #ccc;
            cursor: pointer;
            /* Add active state for immediate feedback */
            transition: filter 0.1s ease;
        }

        .camera-background:active {
            filter: brightness(0.95);
        }

        html, body {
            touch-action: manipulation;
            -ms-touch-action: manipulation;
            overscroll-behavior: none;
        }

        .center-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: black;
            color: white;
            padding: 20px;
            animation: pulse 1s infinite alternate;
            width: 430px;
            text-align: center;
            opacity: 1;
            transition: all 0.3s ease-in-out; /* Faster transitions */
            will-change: transform, opacity; /* GPU acceleration hint */
            border-radius: 8px;
        }

        .pre-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            text-align: center;
            opacity: 1;
            transition: opacity 0.3s ease-in-out; /* Faster transition */
            color: #04cf5c;
            font-size: 72px;
            will-change: opacity;
        }

        .pre-loader .spinner-border {
            --bs-spinner-width: 8rem;
            --bs-spinner-height: 8rem;
            --bs-spinner-vertical-align: -0.125em;
            --bs-spinner-border-width: 0.25em;
            --bs-spinner-animation-speed: 1s; /* Faster spinner */
            --bs-spinner-animation-name: spinner-border;
            border: var(--bs-spinner-border-width) solid currentcolor;
            border-right-color: transparent;
        }

        .modal-body h4 {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .green-box-right, .green-box-left {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #04cf5c;
            border-radius: 4px;
            will-change: transform; /* GPU acceleration */
            transition: transform 0.1s ease;
        }

        .green-box-right {
            position: absolute;
            top: 115px;
            right: -20px;
            width: 150px;
            height: 40px;
        }

        .green-box-left {
            position: absolute;
            top: -20px;
            right: 300px;
            width: 150px;
            height: 40px;
        }

        #flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s ease-in-out; /* Much faster flash */
            z-index: 10;
            will-change: opacity;
        }

        /* Faster modal transitions */
        .modal.fade .modal-dialog {
            transition: transform 0.2s ease-out; /* Faster modal animation */
        }

        .modal.fade {
            transition: opacity 0.2s linear;
        }

        /* Keyboard optimizations */
        .hg-theme-default {
            background-color: #04cf5c;
        }

        .hg-theme-default .hg-button {
            align-items: center;
            background: #000;
            border-bottom: 0px solid #b5b5b5;
            border-radius: 0px;
            box-shadow: 0 0 3px -1px rgba(0, 0, 0, .3);
            box-sizing: border-box;
            cursor: pointer;
            display: flex;
            height: 70px;
            justify-content: center;
            padding: 5px;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            transition: background-color 0.1s ease; /* Faster button feedback */
        }

        .hg-theme-default .hg-button:active {
            background-color: #333;
        }

        .hg-row .hg-button:not(:last-child) {
            margin-right: 1px !important;
        }

        .hg-theme-default .hg-row:not(:last-child) {
            margin-bottom: 1px;
        }

        /* Faster pulse animation */
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1.05); /* Smaller scale for smoother animation */
            }
        }

        /* Snappier button interactions */
        .btn {
            transition: all 0.1s ease !important;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .hidden {
            opacity: 0;
        }

        /* Preload critical elements */
        #camera-feed {
            will-change: auto; /* Let browser optimize */
        }

        /* Optimize countdown display */
        .countdown-display {
            will-change: contents;
            font-feature-settings: "tnum"; /* Tabular numbers for consistent width */
        }
    </style>
</head>

<body>
    <div class="camera-background" onclick="callFlaskRouteAndToggleDiv()">
        <img id="camera-feed" src="/video" alt="Camera Feed"
            style="width: 1280px; height: 800px; object-fit: cover; object-position: center;" loading="eager">
        <div id="flash"></div>
        <div id="myDiv" class="center-box rounded-2">
            <h1 style="font-size: 75px;">TRYK HER</h1>
            <div class="green-box-right rounded-2">
                <h4>FOR SELFIE</h4>
            </div>
            <div class="green-box-left rounded-2">
                <h4 class="fw-light">LYD & LYS</h4>
            </div>
        </div>
        <div id="spinner" class="pre-loader" style="opacity: 0; color: #04cf5c;">
            <div class="spinner-border text-white" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="backdoor" onclick="handleBackdoorClick(event)"
            style="width: 50px; height: 50px; position: absolute; top: 0; right: 0;"></div>
    </div>

    <!-- Modals remain the same but with faster transitions -->
    <div class="modal fade" id="consentModal" data-bs-backdrop="static" tabindex="-1"
        aria-labelledby="consentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered">
            <div class="modal-content bg-black">
                <div class="modal-header">
                    <h5 class="modal-title text-light" id="consentModalLabel">Betingelser</h5>
                </div>
                <div class="modal-body text-light" style="overflow-y: auto;">
                    <h4>Samtykke til fotografering og opbevaringspolitik</h4>
                    <p>Ved at klikke på "Acceptér" giver du dit samtykke til, at vi må tage og opbevare dit foto. Vi
                        forpligter os til at beskytte dit privatliv og håndtere dine personlige oplysninger med største
                        omhu og respekt.</p>

                    <h5>Opbevaring af fotos</h5>
                    <p>Dine fotos vil blive opbevaret sikkert på vores server i <strong>7 dage</strong>. Denne periode
                        giver dig mulighed for at hente og gemme dine fotos. Efter 7 dage vil fotos automatisk blive
                        slettet fra vores systemer som en del af vores forpligtelse til at beskytte din privatlivets
                        fred.</p>

                    <h5>Sletning af fotos</h5>
                    <p>Skulle du ønske, at dit foto bliver slettet før udløbet af de 7 dage, er du velkommen til at
                        kontakte os med en anmodning om sletning. Vi vil sørge for, at dit foto bliver slettet fra vores
                        systemer hurtigst muligt.</p>

                    <h5>Brugsret og forbehold</h5>
                    <p>Vi forbeholder os retten til at anvende fotos taget i vores SelfieBooth til interne formål,
                        herunder forbedring af vores service. Dine fotos vil ikke blive delt med tredjeparter eller
                        anvendt til kommercielle formål uden dit udtrykkelige forudgående samtykke.</p>

                    <h5>Dine rettigheder</h5>
                    <p>Du har ret til at anmode om indsigt i de fotos, vi har opbevaret om dig, samt at få rettet
                        eventuelle unøjagtigheder. Derudover har du ret til at gøre indsigelse mod vores behandling af
                        dine fotos og anmode om begrænsning af behandling af dine personoplysninger.</p>

                    <p>Accept af disse vilkår bekræfter, at du har læst og forstået vores politikker vedrørende
                        opbevaring, sletning af fotos, samt dine rettigheder. Vi er dedikerede til at beskytte dit
                        privatliv og sikre, at dine personoplysninger behandles sikkert og ansvarligt.</p>

                    <p>Har du spørgsmål, eller ønsker du yderligere information om vores fotopolitik, er du altid
                        velkommen til at kontakte os.</p>

                </div>
                <div class="modal-footer">
                    <button type="button" id="declineButton" class="btn btn-black rounded-0 border-light fw-bolder fs-4"
                        style="width: 48%!important; height: 80px;" data-bs-dismiss="modal"
                        onclick="reset()">Afvis</button>
                    <button type="button" class="btn btn-success border-light fw-bolder fs-4 rounded-0"
                        style="width: 48%!important; height: 80px;" data-bs-dismiss="modal"
                        onclick="startCountdown()">Acceptér</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" data-bs-backdrop="static" tabindex="-1"
        aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title text-light" id="settingsModalLabel">Indstillinger</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="wifiSettingsForm" action="/settings" method="POST">
                        <div class="mb-5">
                            <label for="wifiPassword" class="form-label text-light">Adgangskode (WPA2)</label>
                            <div class="input-group">
                                <input type="text" class="input form-control" id="wifiPassword" name="wifiPassword"
                                    placeholder="Indtast WiFi Password">
                            </div>
                        </div>
                        <div class="mb-5">
                            <label for="wifiPassword2" class="form-label text-light">Adgangskode (WPA2)</label>
                            <div class="input-group">
                                <input type="text" class="input form-control" id="wifiPassword2" name="wifiPassword2"
                                    placeholder="Indtast WiFi Password for dag 2">
                            </div>
                        </div>
                    </form>
                    <div class="simple-keyboard"></div>
                    <script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuller</button>
                    <button type="submit" form="wifiSettingsForm" class="btn btn-primary" id="submitBtn">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"
                            style="display: none;" id="spinner"></span>
                        Gem Ændringer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="postCaptureModal" tabindex="-1" aria-labelledby="postCaptureModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered">
            <div class="modal-content bg-black">
                <div class="modal-header">
                    <h3 class="modal-title" id="postCaptureModalLabel">Billede taget!</h3>
                </div>
                <div class="modal-body" style="overflow: hidden;">
                    <h4>Dine billeder er samlet her:</h4>
                </div>
                <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                    <div id="qrCode" class="d-flex justify-content-center align-items-center"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" id="declineButton2"
                        class="btn btn-black rounded-0 border-light fw-bolder fs-4"
                        style="width: 48%!important; height: 80px;" data-bs-dismiss="modal" onclick="reset()">Nej
                        tak</button>
                    <button type="button" class="btn btn-success border-light fw-bolder fs-4 rounded-0"
                        style="width: 48%!important; height: 80px;" data-bs-dismiss="modal"
                        onclick="startCountdown()">Tag ét mere</button>
                </div>
            </div>
        </div>
    </div>
</body>

<script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
    let countdownInterval;
    
    // Optimize DOM queries by caching elements
    const elements = {
        myDiv: document.getElementById('myDiv'),
        flashDiv: document.getElementById('flash'),
        spinner: document.getElementById('spinner'),
        qrCode: document.getElementById('qrCode'),
        cameraBackground: document.querySelector('.camera-background')
    };
    
    document.getElementById('wifiSettingsForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const spinner = document.getElementById('spinner');
        spinner.style.display = 'inline-block';

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;

        const formData = new FormData(event.target);
        const data = {
            wifiPassword: formData.get('wifiPassword'),
            wifiPassword2: formData.get('wifiPassword2'),
        };

        fetch('/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Changes saved successfully');
                const modal = document.getElementById('settingsModal');
                modal.classList.remove('show');
                const backdrop = document.getElementsByClassName('modal-backdrop')[0];
                if (backdrop) backdrop.remove();
                modal.style.display = 'none';
            } else {
                alert(data.message);
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
            submitBtn.disabled = false;
        })
        .finally(() => {
            spinner.style.display = 'none';
        });
    });

    const Keyboard = window.SimpleKeyboard.default;
    const myKeyboard = new Keyboard({
        onChange: input => onChange(input),
        onKeyPress: button => onKeyPress(button)
    });

    function onChange(input) {
        document.querySelector(".input").value = input;
    }

    function onKeyPress(button) {
        console.log("Button pressed", button);
    }
    
    function handleBackdoorClick(event) {
        event.stopPropagation();
        var settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'), {
            keyboard: false,
            backdrop: 'static'
        });
        settingsModal.show();
    }

    function callFlaskRouteAndToggleDiv() {
        var consentModal = new bootstrap.Modal(document.getElementById('consentModal'), {
            keyboard: false,
            backdrop: 'static'
        });

        consentModal.show();
        elements.cameraBackground.setAttribute('onclick', '');

        let countdown = 30;
        const declineBtn = document.getElementById('declineButton');
        declineBtn.innerText = `Afvis (${countdown}s)`;

        countdownInterval = setInterval(() => {
            countdown--;
            declineBtn.innerText = `Afvis (${countdown}s)`;
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                consentModal.hide();
                reset();
            }
        }, 1000);
    }

    function startCountdown() {
        clearInterval(countdownInterval);
        let countdownValue = 3;
        
        // Immediate feedback - start transition right away
        elements.myDiv.style.opacity = '0';

        // Reduced timeout for snappier feel
        setTimeout(() => {
            elements.myDiv.style.opacity = '1';
            elements.myDiv.style.backgroundColor = 'transparent';
            elements.myDiv.style.animation = 'none';
            elements.myDiv.innerHTML = `<h1 class="countdown-display" style="font-size: 120px;">${countdownValue}</h1>`;
            elements.myDiv.classList.remove('hidden');
            
            const countdownInterval = setInterval(() => {
                countdownValue--;
                if (countdownValue > -1) {
                    elements.myDiv.innerHTML = `<h1 class="countdown-display" style="font-size: 120px;">${countdownValue}</h1>`;
                } else {
                    clearInterval(countdownInterval);
                    elements.myDiv.innerHTML = '';
                    elements.myDiv.style.opacity = '0';
                    flashAndCapture();
                }
            }, 1000);
        }, 300); // Reduced from 700ms
    }

    let isFirstCapture = true;

    function flashAndCapture() {
        // Immediate flash feedback
        elements.flashDiv.style.opacity = '1';

        // Shorter flash duration for snappier feel
        setTimeout(() => {
            elements.flashDiv.style.opacity = '0';
        }, 600); // Reduced from 1000ms

        const endpoint = isFirstCapture ? '/capture' : '/capture_next';

        // Start capture request immediately, don't wait
        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Photo captured successfully:', data);
                    showQRCodeOrOfflineMessage(data);
                    showPostCaptureModal();
                } else {
                    console.error('Capture failed:', data.message);
                    alert('Fejl ved billede: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error capturing photo:', error);
                alert('Netværksfejl ved billede optagelse');
            });

        isFirstCapture = false;
    }

    function showQRCodeOrOfflineMessage(data) {
        var modalBodyElement = document.querySelector("#postCaptureModal .modal-body h4");
        
        elements.qrCode.innerHTML = ''; // Clear previous content
        
        if (data.offline_mode) {
            const offlineMessage = data.offline_message || "Arrangørene får billederne efter arrangement";
            modalBodyElement.textContent = offlineMessage;
            
            elements.qrCode.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; border: 3px dashed #04cf5c; border-radius: 15px; background-color: rgba(4, 207, 92, 0.1);">
                    <div style="font-size: 48px; margin-bottom: 20px;">📱</div>
                    <div style="font-size: 24px; color: #04cf5c; font-weight: bold; margin-bottom: 10px;">Offline Mode</div>
                    <div style="font-size: 16px; color: #ffffff; opacity: 0.8;">Billederne gemmes lokalt</div>
                </div>
            `;
        } else {
            modalBodyElement.textContent = "Dine billeder er samlet her:";
            
            if (data.url) {
                new QRCode(elements.qrCode, {
                    text: data.url,
                    width: 512,
                    height: 512,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            } else {
                elements.qrCode.innerHTML = '<div style="text-align: center; padding: 40px; font-size: 18px; color: #ff6b6b;">QR kode kunne ikke genereres</div>';
            }
        }
    }

    function showQRCode(url) {
        showQRCodeOrOfflineMessage({ url: url, offline_mode: false });
    }

    function showPostCaptureModal() {
        let postCaptureModal = new bootstrap.Modal(document.getElementById('postCaptureModal'));
        postCaptureModal.show();

        if (countdownInterval !== null) {
            clearInterval(countdownInterval);
        }

        let countdown = 30;
        const declineBtn2 = document.getElementById('declineButton2');
        declineBtn2.innerText = `Nej tak (${countdown}s)`;

        countdownInterval = setInterval(() => {
            countdown--;
            declineBtn2.innerText = `Nej tak (${countdown}s)`;
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                countdownInterval = null;
                postCaptureModal.hide();
                reset();
            }
        }, 1000);
    }

    function reset() {
        clearInterval(countdownInterval);
        isFirstCapture = false;

        elements.cameraBackground.setAttribute('onclick', 'callFlaskRouteAndToggleDiv()');

        // Batch DOM updates for better performance
        elements.myDiv.innerHTML = '<h1 style="font-size: 75px;">TRYK HER</h1>' +
            '<div class="green-box-right rounded-2">' +
            '<h4>FOR SELFIE</h4></div>' +
            '<div class="green-box-left rounded-2">' +
            '<h4 class="fw-light">LYD & LYS</h4></div>';

        // Apply all style changes at once
        Object.assign(elements.myDiv.style, {
            backgroundColor: 'black',
            animation: 'pulse 1s infinite alternate',
            opacity: '1'
        });

        elements.spinner.style.opacity = '0';
        elements.flashDiv.style.opacity = '0';
        elements.myDiv.classList.remove('hidden');

        isFirstCapture = true;
        elements.qrCode.innerHTML = '';

        var postCaptureModalElement = document.getElementById('postCaptureModal');
        var modal = bootstrap.Modal.getInstance(postCaptureModalElement);
        if (modal) {
            modal.hide();
        }
    }

    // Preload critical functions on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Warm up the QR code library
        if (typeof QRCode !== 'undefined') {
            console.log('QR Code library ready');
        }
    });
</script>

</html>
